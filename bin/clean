#!/usr/bin/env python3
import click
import git
import os

git_check_subdirs = [
    "~",
    "~/Code",
    "~/Git",
    "~/.config",
]

allowed_hidden_files = set([
    ".bashrc",
    ".cache",
    ".config",
    ".gnupg",
    ".local",
    ".mozilla",
    ".pki",
    ".ssh",
    ".vim",
])

home = os.path.expanduser("~")
hidden_files = [f.name for f in os.scandir(home) if f.name[0] == '.']
extra_files = set(hidden_files) - allowed_hidden_files

if extra_files:
    print("Extra files found:")
    for f in sorted(extra_files):
        print("\t" + f)
else:
    print("No extra files found in ~")


def is_git_project(dirpath):
    return os.path.isdir(os.path.join(dirpath, ".git"))

git_projects = []
for dirname in git_check_subdirs:
    dirname = os.path.expanduser(dirname)
    for de in os.scandir(dirname):
        if de.is_dir() and is_git_project(de.path):
            git_projects.append(de.path)

for project_dir in git_projects:
    repo = git.Repo(project_dir)
    if repo.is_dirty(untracked_files=True):
        print(project_dir + " is dirty")
        for f in repo.untracked_files:
            print(f"\t{f}")

whitelist = {os.path.expanduser(p) for p in ["~/Code/code-archive", "~/Code/hello-rust-book"]}
for de in os.scandir(os.path.expanduser("~/Code")):
    if de.is_dir() and not is_git_project(de.path) and de.path not in whitelist:
        print(de.path + " isn't in git")
